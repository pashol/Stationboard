#include <Arduino.h>
#include <WiFi.h>
#include <HTTPClient.h>
#include <SPI.h>
#include "TFT_eSPI.h"
#include <WiFiUdp.h>
#include <NTPClient.h>
#include <FS.h>
#include <JsonListener.h>
#include <JsonStreamingParser.h>

#define AA_FONT_SMALL "NotoSansBold15"
#define AA_FONT_LARGE "NotoSansBold36"
#define STATION "8577582"
#define LIMIT 8
#define POS_TIME 3
#define POS_BUS  80
#define POS_TO   130
#define POS_INC  18
#define POS_FIRST 30

int newLine = POS_FIRST;

const char* ssid = "Fortuna";
const char* password = "Allrueti136343Rotkreuz";
String base_url = "http://transport.opendata.ch/v1/stationboard?id=";
String url_limit = "&limit=";
String url = "http://transport.opendata.ch/v1/stationboard?id=8577582&limit=2"; // Fallback

TFT_eSPI tft = TFT_eSPI();
WiFiUDP ntpUDP;
NTPClient timeClient(ntpUDP);

extern int newLine;
extern TFT_eSPI tft;

class MyJsonListener : public JsonListener {
  public:
    static int calculateDelay(const char* scheduled, const char* prognosis) {
      if (!scheduled || !prognosis) return 0;
      int schHour = atoi(scheduled);
      int schMin = atoi(scheduled);
      int progHour = atoi(prognosis);
      int progMin = atoi(prognosis);
      int scheduledMinutes = schHour * 60 + schMin;
      int prognosisMinutes = progHour * 60 + progMin;
      if (prognosisMinutes < scheduledMinutes - 720) {
        prognosisMinutes += 24 * 60;
      }
      return prognosisMinutes - scheduledMinutes;
    }

    static void displayEntry(const char* departure, int delay, const char* category,
                   const char* number, const char* to) {
      tft.setCursor(POS_TIME, newLine);
      tft.printf("%.*s", 5, departure + 11);
      if (delay > 0) {
          tft.setTextColor(TFT_RED, TFT_BLUE);
          tft.printf(" +%d", delay);
          tft.setTextColor(TFT_WHITE, TFT_BLUE);
      }
      tft.setCursor(POS_BUS, newLine);
      tft.printf("%-1s%-3s", category, number);
      tft.setCursor(POS_TO, newLine);
      tft.printf("%-20s", to);
      newLine += POS_INC;
      Serial.printf("Bus %s%s nach %s: %s (Verspätung: %d min)\n",
                   category, number, to, departure, delay);
    }

    void startDocument() {
      Serial.println("Start parsing document");
      // Reset Values at start of document
      departure = "";
      prognosisDeparture = "";
      number = "";
      category = "";
      to = "";
      inStationboard = false;
    }

    void endDocument() {
      Serial.println("End parsing document");
    }

    void startArray() {
      if (currentKey == "stationboard") {
        inStationboard = true;
      }
    }

    void endArray() {
      if (inStationboard) {
        inStationboard = false;
      }
    }

    void startObject() {
    }

    void endObject() {
      // Wenn wir alle Werte für ein Objekt haben, zeigen wir sie an
      if (inStationboard && !departure.isEmpty() && !number.isEmpty()) {
        const char* dep = departure.c_str();
        const char* prog = prognosisDeparture.c_str();
        int delay = calculateDelay(dep, prog);
        
        displayEntry(dep, delay, category.c_str(), 
                    number.c_str(), to.c_str());
                    
        // Reset values for next object
        departure = "";
        prognosisDeparture = "";
        number = "";
        category = "";
        to = "";
      }
    }

    void key(String key) {
      currentKey = key;
    }

    void value(String value) {
      if (currentKey == "departure") {
        departure = value;
      } else if (currentKey == "departure") {  // This was a bug, should be prognosisDeparture
        prognosisDeparture = value;
      } else if (currentKey == "number") {
        number = value;
      } else if (currentKey == "category") {
        category = value;
      } else if (currentKey == "to") {
        to = value;
      }
    }

    void whitespace(char c) {}

    String currentKey;
    String departure;
    String prognosisDeparture;
    String number;
    String category;
    String to;
    bool inStationboard;
};

void drawHeader() {
    tft.loadFont(AA_FONT_SMALL);
    tft.fillScreen(TFT_BLUE);
    tft.setTextColor(TFT_BLACK, TFT_WHITE);
    tft.fillRect(0, 0, tft.width(), 25, TFT_WHITE);
    tft.setCursor(POS_BUS, 7);
    tft.print("Bus");
    tft.setCursor(POS_TO, 7);
    tft.print("Nach");
    tft.setTextColor(TFT_WHITE, TFT_BLUE);
}

void drawCurrentTime() {
    timeClient.update();
    tft.loadFont(AA_FONT_SMALL);
    tft.setTextColor(TFT_BLACK, TFT_WHITE);
    tft.fillRect(0, tft.height() - 25, tft.width(), 25, TFT_WHITE);
    tft.setCursor(4, tft.height() - 20);
    tft.print("Zeit: ");
    tft.print(timeClient.getFormattedTime());
}

MyJsonListener listener;
JsonStreamingParser parser;

void setup() {
  Serial.begin(115200);

  if (psramInit()) {
      Serial.println("PSRAM initialized");
      Serial.printf("Total PSRAM: %d bytes\n", ESP.getPsramSize());
      Serial.printf("Free PSRAM: %d bytes\n", ESP.getFreePsram());
  } else {
      Serial.println("PSRAM not available");
  }

  tft.begin();
  tft.setRotation(1);
  tft.fillScreen(TFT_BLACK);
  tft.setTextColor(TFT_WHITE);
  tft.setTextSize(1);
  WiFi.begin(ssid, password);
  
  url = base_url + STATION + url_limit + LIMIT;

  timeClient.begin();
  timeClient.setTimeOffset(3600);

  while (WiFi.status() != WL_CONNECTED) {
    delay(1000);
    Serial.println("Connecting to WiFi...");
    tft.drawString("Connecting to WiFi...", 20, 100);
  }
  
  Serial.println("Connected to WiFi");
  tft.fillScreen(TFT_BLACK);
  tft.drawString("Connected to WiFi", 20, 100);
  delay(2000);

  if (!SPIFFS.begin()) {
    Serial.println("SPIFFS initialisation failed!");
    while (1) yield();
  }
  Serial.println("\r\nSPIFFS available!");
  
  bool font_missing = false;
  if (SPIFFS.exists("/NotoSansBold15.vlw") == false) font_missing = true;
  if (SPIFFS.exists("/NotoSansBold36.vlw") == false) font_missing = true;

  if (font_missing) {
    Serial.println("\r\nFont missing in SPIFFS, did you upload it?");
    while(1) yield();
  } else {
    Serial.println("\r\nFonts found OK.");
  }

  parser.setListener(&listener);
}

void loop() {
  if (WiFi.status() == WL_CONNECTED) {
    HTTPClient http;
    Serial.print("URL: ");
    Serial.println(url);
    http.begin(url);

    int httpResponseCode = http.GET();
    Serial.print("HTTP Response Code: ");
    Serial.println(httpResponseCode);

    drawHeader();

    if (httpResponseCode == HTTP_CODE_OK) {
      WiFiClient& stream = http.getStream();
      while (stream.available()) {
        char c = stream.read();
        parser.parse(c);
      }
    } else {
      Serial.print("HTTP request failed, error code: ");
      Serial.println(httpResponseCode);
    }
   
    http.end();
    drawCurrentTime();
  }

  newLine = POS_FIRST;
  Serial.println("============ End of Request ====================");
  delay(60000);
}